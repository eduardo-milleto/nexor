# =============================================================================
# Deploy to Production - MANUAL TRIGGER with approval required
# =============================================================================
name: Deploy Production

on:
  # Option 1: Manual trigger (recommended)
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.2.3)'
        required: true
        type: string
      confirm:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

  # Option 2: Tag-based (v1.0.0, v1.1.0, etc.)
  push:
    tags:
      - 'v*'

jobs:
  # ============================================
  # Step 1: Verify staging tests passed
  # ============================================
  verify:
    name: Verify Staging Status
    runs-on: ubuntu-latest
    
    steps:
      - name: Check manual confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]; then
            echo "‚ùå You must type 'DEPLOY' to confirm production deployment"
            exit 1
          fi
          echo "‚úÖ Deployment confirmed"

      - name: Verify staging workflow passed
        uses: actions/github-script@v7
        with:
          script: |
            // Get the latest staging workflow run
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-staging.yml',
              branch: 'main',
              status: 'success',
              per_page: 1
            });
            
            if (runs.data.total_count === 0) {
              core.setFailed('‚ùå No successful staging deployment found. Deploy to staging first!');
            }
            
            console.log('‚úÖ Staging deployment verified');

  # ============================================
  # Step 2: Deploy to Production (requires approval)
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: verify
    environment: 
      name: production
      # This enables manual approval in GitHub!
      # Configure in: Settings ‚Üí Environments ‚Üí production ‚Üí Required reviewers
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Deploy Frontend to Vercel (Production)
        working-directory: ./frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          for attempt in 1 2 3; do
            echo "üöÄ Vercel deploy attempt $attempt/3"
            if vercel deploy --prod --token "$VERCEL_TOKEN" --confirm; then
              exit 0
            fi
            echo "‚ö†Ô∏è Vercel deploy failed. Retrying in 15s..."
            sleep 15
          done
          echo "‚ùå Vercel deploy failed after 3 attempts."
          exit 1

      # Railway auto-deploys from GitHub - no webhook needed!
      - name: Backend Deploy Status
        run: |
          echo "‚úÖ Railway will auto-deploy the backend from this push"
          echo "üìç Production URL: https://nexor-production.up.railway.app"

      - name: Create GitHub Release
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${{ github.event.inputs.version }}`,
              name: `Release v${{ github.event.inputs.version }}`,
              body: `Production deployment v${{ github.event.inputs.version }}\n\nDeployed by @${{ github.actor }}`,
              draft: false,
              prerelease: false
            });

      - name: Notify success
        run: |
          echo "üéâ Production deployment complete!"
          echo "Frontend: https://nexor-eta.vercel.app"
          echo "Backend: https://nexor-production.up.railway.app"
